ACC.productDetail = {

    _autoload: [
        "initPageEvents",
        "bindVariantOptions",
        ["adjustRelatedProductsWidth", $(".js-related-products-container").length > 0],
        ["loadZoomImage", $(".pdp__image__thumb").length > 0],
        ["pdpMedias", $(".js-pdp-medias").length > 0],
        ["thumbnailsPDP", $(".pdp__thumbnails").length]
    ],
    
    checkQtySelector: function (self, mode) {
        const $qtySelector = $(document).find(self).parents(".js-qty-selector");
        const input = $qtySelector.find(".js-qty-selector-input");
        const inputVal = parseInt(input.val());
        const max = input.data("max");
        const minusBtn = $qtySelector.find(".js-qty-selector-minus");
        const plusBtn = $qtySelector.find(".js-qty-selector-plus");

        $qtySelector.find(".btn").removeAttr("disabled");

        if (mode === "minus") {
            if (inputVal !== 1) {
                ACC.productDetail.updateQtyValue(self, inputVal - 1);
                if (inputVal - 1 === 1) {
                    minusBtn.attr("disabled", "disabled");
                }

            } else {
                minusBtn.attr("disabled", "disabled");
            }
        } else if (mode === "reset") {
            ACC.productDetail.updateQtyValue(self, 1);
        } else if (mode === "plus") {
            if (max === "FORCE_IN_STOCK") {
                ACC.productDetail.updateQtyValue(self, inputVal + 1);
            } else if (inputVal <= max) {
                ACC.productDetail.updateQtyValue(self, inputVal + 1);
                if (inputVal + 1 === max) {
                    plusBtn.attr("disabled", "disabled");
                }
            } else {
                plusBtn.attr("disabled", "disabled");
            }
        } else if (mode === "input") {
            if (inputVal === 1) {
                minusBtn.attr("disabled", "disabled");
            } else if (max === "FORCE_IN_STOCK" && inputVal > 0) {
                ACC.productDetail.updateQtyValue(self, inputVal);
            } else if (inputVal === max) {
                plusBtn.attr("disabled", "disabled");
            } else if (inputVal < 1) {
                ACC.productDetail.updateQtyValue(self, 1);
                minusBtn.attr("disabled", "disabled");
            } else if (inputVal > max) {
                ACC.productDetail.updateQtyValue(self, max);
                plusBtn.attr("disabled", "disabled");
            }
        } else if (mode === "focusout") {
            if (isNaN(inputVal)) {
                ACC.productDetail.updateQtyValue(self, 1);
                minusBtn.attr("disabled", "disabled");
            } else if (inputVal >= max) {
                plusBtn.attr("disabled", "disabled");
            }
        }

    },

    updateQtyValue: function (self, value) {
        const input = $(document).find(self).parents(".js-qty-selector").find(".js-qty-selector-input");
        const addtocartQty = $(document).find(self).parents(".addtocart-component").find("#addToCartForm").find(".js-qty-selector-input");
        const configureQty = $(document).find(self).parents(".addtocart-component").find("#configureForm").find(".js-qty-selector-input");
        input.val(value);
        addtocartQty.val(value);
        configureQty.val(value);
    },

    initPageEvents: function () {
        $(document).on("click", '.js-qty-selector .js-qty-selector-minus', function () {
            ACC.productDetail.checkQtySelector(this, "minus");
        });

        $(document).on("click", '.js-qty-selector .js-qty-selector-plus', function () {
            ACC.productDetail.checkQtySelector(this, "plus");
        });

        $(document).on("keydown", '.js-qty-selector .js-qty-selector-input', function (e) {
            if (($(this).val() !== " " && ((e.which >= 48 && e.which <= 57) || (e.which >= 96 && e.which <= 105))) || e.which === 8 || e.which === 46 || e.which === 37 || e.which === 39 || e.which === 9) {
            } else if (e.which === 38) {
                ACC.productDetail.checkQtySelector(this, "plus");
            } else if (e.which === 40) {
                ACC.productDetail.checkQtySelector(this, "minus");
            } else {
                e.preventDefault();
            }
        });

        $(document).on("keyup", '.js-qty-selector .js-qty-selector-input', function () {
            ACC.productDetail.checkQtySelector(this, "input");
            ACC.productDetail.updateQtyValue(this, $(this).val());
        });

        $(document).on("focusout", '.js-qty-selector .js-qty-selector-input', function () {
            ACC.productDetail.checkQtySelector(this, "focusout");
            ACC.productDetail.updateQtyValue(this, $(this).val());
        });

        $("#Size").change(function () {
            changeOnVariantOptionSelection($("#Size option:selected"));
        });

        $("#variant").change(function () {
            changeOnVariantOptionSelection($("#variant option:selected"));
        });

        $(".selectPriority").change(function () {
            window.location.href = $(this[this.selectedIndex]).val();
        });

        function changeOnVariantOptionSelection(optionSelected) {
            window.location.href = optionSelected.attr('value');
        }
    },

    bindVariantOptions: function () {
        ACC.productDetail.bindCurrentStyle();
        ACC.productDetail.bindCurrentSize();
        ACC.productDetail.bindCurrentType();
    },

    bindCurrentStyle: function () {
        const currentStyle = $("#currentStyleValue").data("styleValue");
        const styleSpan = $(".styleName");
        if (currentStyle != null) {
            styleSpan.text(": " + currentStyle);
        }
    },

    bindCurrentSize: function () {
        const currentSize = $("#currentSizeValue").data("sizeValue");
        const sizeSpan = $(".sizeName");
        if (currentSize != null) {
            sizeSpan.text(": " + currentSize);
        }
    },

    bindCurrentType: function () {
        const currentSize = $("#currentTypeValue").data("typeValue");
        const sizeSpan = $(".typeName");
        if (currentSize != null) {
            sizeSpan.text(": " + currentSize);
        }
    },

    adjustRelatedProductsWidth: function () {
        const container = $(".js-related-products-container");
        container.each(function () {
                const content = $(this).find(".js-related-products-content");
                const items = $(this).find(".js-related-products-item");
                content.css({
                    "width": (items.outerWidth() * items.length) + (parseInt(items.css("margin-right")) * (items.length - 1)),
                    "height": "auto"
                });
            }
        )
    },

    loadZoomImage: function () {
        const device = navigator.userAgent.toLowerCase();
        const pdpImageThumb = $(".pdp__image__thumb");
        const pdpImagePreview = $(".pdp__image__preview");

        if (device.search(/iphone|ipod|ipad|android/) > 0) {
            const body = $("body");
            const modalPdp = "<div class='pdp__modal'>" +
                "<div class='pdp__modal__content'>" +
                "<button class='pdp__modal__close'><i class='shoprite-icon-close'></i></button>" +
                "<div class='pdp__modal__body'>" +
                "<div class='pdp__modal__image-container'>" +
                "<img class='pdp__modal__image' src='" + pdpImageThumb.attr("src") + "'>" +
                "</div>" +
                "</div>" +
                "</div>" +
                "</div>";
            body.append(modalPdp);

            const pdpModal = $(".pdp__modal");
            const pdpModalClose = pdpModal.find(".pdp__modal__close");
            let isLoaded = false;

            pdpImageThumb.on("click", function () {
                pdpModal.addClass("is-show");
                $("html").addClass("block");

                if (!isLoaded) {
                    const el = document.querySelector('.pdp__modal__image-container');
                    const pz = new PinchZoom.default(el, {
                        maxZoom: 8,
                        draggableUnzoomed: false
                    });
                    isLoaded = true;
                }
            });

            pdpModalClose.on("click", function () {
                pdpModal.removeClass("is-show");
                $("html").removeClass("block");
            })
        } else {
            const drift = new Drift(pdpImageThumb[0], {
                paneContainer: pdpImagePreview[0],
                inlinePane: 900,
                inlineOffsetY: -85,
                containInline: true,
                hoverBoundingBox: true
            });
        }
    },

    pdpMedias: function () {
        const jsPdpMedias = $(".js-pdp-medias");
        const imageFull = jsPdpMedias.find(".pdp__medias__image-full");
        const images = jsPdpMedias.find(".pdp__medias__image");

        if (images.length > 0) {
            imageFull.html("<img src='" + images.eq(0).find("img").data("zoom") + "'>");

            images.on("click", function () {
                const image = $(this);
                const img = image.find("img");
                imageFull.html("<img src='" + img.data("zoom") + "'>");
                images.removeClass("is-active");
                image.addClass("is-active");
            });
        }
    },

    thumbnailsPDP: function () {
        const device = navigator.userAgent.toLowerCase();
        const $pdpThumbnails = $(".pdp__thumbnails");
        const $thumbnails = $pdpThumbnails.find(".thumbnail");
        const $pdpImageThumb = $(".pdp__image__thumb");

        $thumbnails.on("click", function () {
            const originalImage = $(this).find("img").data("originalSrc");
            const zoomImage = $(this).find("img").data("zoomImage");
            $thumbnails.removeClass("thumbnail__active");
            $(this).addClass("thumbnail__active");
            $pdpImageThumb.attr({
                "src": originalImage,
                "data-zoom": zoomImage
            });

            if (device.search(/iphone|ipod|ipad|android/) > 0) {
                $(".pdp__modal__image").attr("src", originalImage);
            }
        });
    }
};
