ACC.loyaltyCard = {
    _autoload: [
        ["bindLoyaltyCardSubmit", $(".js-submit-link-card").length !== 0],
        ["showCardErrorPopup", $(".js-card-error").data("cardError")],
        "bindSAIDPassportInput",
        "gaEventsTriggers",
        ["bindEnableButton", $(".js-loyalty-card-form").length]
    ],

    bindLoyaltyCardSubmit: function () {
        $(document).on("keyup", "input.js-xtra-saving-input", function () {
            const $this = $(this);
            const $valInput = $this.val();
            if ($valInput !== "") $this.addClass("is-used");
            else $this.removeClass("is-used");

            if ($valInput.length === 4) {
                const nextTarget = $this.data("nextTarget");
                if (nextTarget !== "") {
                    $this.parent().find("#" + nextTarget).focus();
                }
            }
        });

        $(document).on("click", ".js-submit-link-card", function (event) {
            event.preventDefault();
            let cardId;
            const firstNumbers = $("input.card-first-numbers").val();
            const secondNumbers = $("input.card-second-numbers").val();
            const thirdNumbers = $("input.card-third-numbers").val();
            const fourthNumbers = $("input.card-fourth-numbers").val();
            cardId = firstNumbers.concat(secondNumbers, thirdNumbers, fourthNumbers);

            $("input[name='cardId']").val(cardId);

            $(".loading-background").show();
            $(this).parents("form").submit();
        });
    },

    showCardErrorPopup: function () {
        ACC.colorbox.open("", {
            html: $(".js-card-error").html(),
            className: "card-number-used-container",
            width: "340px"
        });
    },

    bindSAIDPassportInput: function () {
        $(document).on("click", ".js-change-identification", function (event) {
            const $target = $(event.currentTarget);
            const $saidSelector = $("#user-said");
            const $saidErrorSelector = $("span[id^='customerSAId']");
            const $passportErrorSelector = $("span[id^='customerPassport']");
            const $passportSelector = $("#user-passport");

            if ($target.data("identification") === "passport") {
                $saidSelector.val("");
                $saidErrorSelector.hide();
                $saidSelector.attr("hidden", true);
                $target.attr("hidden", true);

                $passportSelector.attr("hidden", false);
                $(".js-change-identification[data-identification='said']").attr("hidden", false);
            } else if ($target.data("identification") === "said") {
                $passportSelector.val("");
                $passportErrorSelector.hide();
                $passportSelector.attr("hidden", true);
                $target.attr("hidden", true);

                $saidSelector.attr("hidden", false);
                $(".js-change-identification[data-identification='passport']").attr("hidden", false);
            }
        });
    },

    gaEventsTriggers: function () {
        $("#linkYourCard").on("click", function () {
            ACC.global.gaEvent("Card Management", "Link New Card Start", "Started");
        });

        $("#stopCardButton").on("click", function () {
            ACC.global.gaEvent("Card Management", "Stop Card", "Stopped");
        });

        $("#cancelCardButton").on("click", function () {
            ACC.global.gaEvent("Card Management", "Cancel membership", "Cancel");
        });
    },

    bindEnableButton: function () {
        $('.js-xtra-saving-input').on('keyup', function () {
            const firstNumbers = $("input.card-first-numbers").val();
            const secondNumbers = $("input.card-second-numbers").val();
            const thirdNumbers = $("input.card-third-numbers").val();
            const fourthNumbers = $("input.card-fourth-numbers").val();
            cardId = firstNumbers.concat(secondNumbers, thirdNumbers, fourthNumbers);

            if (ACC.loyaltyCard.isValidInput(firstNumbers, secondNumbers, thirdNumbers, fourthNumbers)) {
                $('.js-submit-link-card').prop('disabled', false)
            } else {
                $('.js-submit-link-card').prop('disabled', true)
            }

            if (isNaN(cardId)) {
                $('.js-card-error-message').prop('hidden', false)
            } else {
                $('.js-card-error-message').prop('hidden', true)
            }
        })
    },

    isValidInput: function (firstNumbers, secondNumbers, thirdNumbers, fourthNumbers) {
        const inputsCard = [firstNumbers, secondNumbers, thirdNumbers, fourthNumbers]

        for (const input of inputsCard) {
            if (input.length != 4) {
                return false
            } else if (isNaN(input)) {
                return false
            }
        }
        return true
    }
};
