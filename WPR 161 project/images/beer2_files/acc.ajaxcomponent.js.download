ACC.ajaxcomponent = {

    _autoload: [
        ["loadHeaderPromotionalAlerts", $(".js-header-promotion-alerts-content").length > 0]
    ],

    loadHeaderOffers: function () {
        const component = $(".js-offers-header-component");
        const componentId = component.data("componentId");
        const baseUrl = component.data("baseUrl");

        if (!component.data("initialized") === true) {
            $.ajax({
                type: "GET",
                url: baseUrl,
                data: ({componentId: componentId}),
                success: ACC.ajaxcomponent.populateOffers(),
                error: function () {
                    console.error("An error occurred when loading component " + componentId);
                }
            });

            component.data("initialized", true);
        }
    },

    loadGridComponent: function () {
        const components = $(".js-facet-aware-product-grid-component");

        components.each(function () {
            let component = $(this);
            if (!component.data("initialized") === true) {
                ACC.ajaxcomponent.loadAjaxComponent(component, ACC.ajaxcomponent.updateGridComponent(component, false));
                component.data("initialized", true);
            }
        });

        ACC.ajaxcomponent.bindProductGridComponent();
        if ($(".js-facet-form").length === 0) {
            ACC.refinements.bindMoreLessToggles();
        }
    },

    updateGridComponent: function (component, closePopup) {
        return function (data) {
            const gridComponentContent = $(data);
            if (gridComponentContent.hasClass('js-facet-aware-product-grid-component-content')) {
                ACC.refinements.bindFilterForInputSearch(gridComponentContent.find(".facet__input-search"));
                component.find('.js-facet-aware-product-grid-component-content').replaceWith(gridComponentContent);
                ACC.product.populateProductsWithHeavyAttributes();
            }
            if (closePopup) {
                ACC.colorbox.close();
            }
        }
    },

    bindProductGridComponent: function () {
        $(document).on("change", ".js-product-facet .js-product-grid-facet-checkbox", function () {
            const isInPopup = $(this).closest("#colorbox").length > 0;
            if (!isInPopup) {
                const component = ACC.ajaxcomponent.findRelatedFacetAwareProductGridComponent($(this));
                const form = $(this).parents("form");
                if (component.length && form.length) {
                    ACC.ajaxcomponent.loadAjaxComponent(component, ACC.ajaxcomponent.updateGridComponent(component, false),
                        ACC.ajaxcomponent.convertFormToObject(form));
                }
            }
        });

        $(document).on("click", ".js-product-grid-facet-link", function (e) {
            e.preventDefault();
            const component = ACC.ajaxcomponent.findRelatedFacetAwareProductGridComponent($(this));
            const isInPopup = $(this).closest("#colorbox").length > 0;
            if (component.length) {
                ACC.ajaxcomponent.loadAjaxComponent(component, ACC.ajaxcomponent.updateGridComponent(component, isInPopup),
                    null, $(this).attr('href'));
            }
        });

        $(document).on("change", "form[id^=sortFormAjax1-]", function () {
            const component = ACC.ajaxcomponent.findRelatedFacetAwareProductGridComponent($(this));
            if (component.length) {
                ACC.ajaxcomponent.loadAjaxComponent(component, ACC.ajaxcomponent.updateGridComponent(component, false),
                    ACC.ajaxcomponent.convertFormToObject($(this)));
            }
        });
    },

    findRelatedFacetAwareProductGridComponent: function (item) {
        let component = item.closest(".js-facet-aware-product-grid-component");
        if (component.length === 0) {
            const componentId = item.closest(".js-product-facet").data("component-id");
            component = $(".js-facet-aware-product-grid-component[data-component-id=" + componentId + "]");
        }
        return component;
    },

    loadAjaxComponent: function (component, successHandler, params, url) {
        const componentId = component.data("componentId");
        const data = Object.assign({componentId: componentId}, params);
        const baseUrl = url == null ? component.data("baseUrl") : url;

        $.ajax({
            type: "GET",
            url: baseUrl,
            data: data,
            success: successHandler,
            error: function () {
                console.error("An error occurred when loading component " + componentId);
            }
        });
    },

    populateOffers: function () {
        return function (data) {
            const offersContent = $(data);
            if (offersContent.hasClass("js-offers-header-content")) {
                $(".js-offers-header-number").replaceWith(offersContent.find(".js-offers-header-number"));
                $(".js-offers-header-content").replaceWith(offersContent.find(".js-offers-header-content"));
                $(".profile__menu__offers").removeClass("hidden");
            }
        }
    },

    loadHeaderPromotionalAlerts: function () {
        const promoAlertsContainer = $(".js-header-promotion-alerts-content");
        if (promoAlertsContainer.length) {
            const baseUrl = promoAlertsContainer.data("baseUrl");
            $.ajax({
                type: "GET",
                url: baseUrl,
                success: ACC.ajaxcomponent.populatePromotionalAlertContent(),
                error: function () {
                    console.error("An error occurred when loading the promotional alerts on the header");
                }
            });
        }
    },

    populatePromotionalAlertContent: function () {
        return function (data) {
            const $submenu = $(".promo-alerts__submenu")
            const $title = $submenu.find('.promo-alerts-signed__title')
            $title.empty()

            if (data.indexOf("promo-alerts-empty") >= 0) {
                $submenu.addClass("is-empty");
                $title.append('Welcome to <br /><span class="promo-color-text">Promo Alerts</span>')

            } else {
                $submenu.removeClass("is-empty");
                $title.append('Promo Alerts')
            }
            const promotionalAlertsContent = $(data);
            if (promotionalAlertsContent.hasClass("js-header-promotion-alerts-content")) {
                $(".js-header-promotion-alerts-content").replaceWith(promotionalAlertsContent);
                ACC.promoAlerts.normalizePromotionsBoxHeight("menu");
            }
        }
    },

    convertFormToObject: function ($form) {
        const formData = $form.serializeArray();
        let data = {};
        $(formData).each(function (index, obj) {
            data[obj.name] = obj.value;
        });

        return data;
    }
};

$(function () {
    if ($(".js-offers-header-component").length) {
        if (ACC.common.isSmartEditEnabled() && ACC.common.isReprocessPageEnabled()) {
            window.smartedit.addOnReprocessPageListener(ACC.ajaxcomponent.loadHeaderOffers);
            window.smartedit.reprocessPage();
        } else {
            ACC.ajaxcomponent.loadHeaderOffers();
        }
    }
});

$(function () {
    if ($(".js-facet-aware-product-grid-component").length) {
        if (ACC.common.isSmartEditEnabled() && ACC.common.isReprocessPageEnabled()) {
            window.smartedit.addOnReprocessPageListener(ACC.ajaxcomponent.loadGridComponent);
            window.smartedit.reprocessPage();
        } else {
            ACC.ajaxcomponent.loadGridComponent();
        }
    }
});
