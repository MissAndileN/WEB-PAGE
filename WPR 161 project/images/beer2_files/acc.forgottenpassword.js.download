ACC.forgottenpassword = {

    _autoload: [
        ["bindForgottenPasswordValidation", $("#shrForgottenPasswordIdentificationForm").length > 0],
        ["doInitialValidation", $("#shrForgottenPasswordIdentificationForm").length > 0],
        ["bindForgottenPasswordOtpSubmit", $("#shrForgottenPasswordIdentificationForm").length > 0],
        ["bindResendOtpAction", $("#shrForgottenPasswordIdentificationForm").length > 0],
        ["bindResendEmailAction", $("#shrForgottenPasswordIdentificationForm").length > 0],
        ["bindBackArrowClick", $(".js-forgotten-password-back-arrow").length > 0],
        ["gaEventsTriggers", $(".forgotten-password-identification-submit").length > 0],
        ["bindNewPasswordValidation", $("#shrSetPasswordForm").length]
    ],

    bindForgottenPasswordValidation: function () {
        $.validator.addMethod("emailOrMobile", function (value, element) {
            return this.optional(element) || ($.isNumeric(value) ? ACC.validations.validateMobileNumber(value) : ACC.validations.validateEmail(value));
        }, loc("input.enter.email.or.phone"));

        $.validator.addMethod("validUsername", function () {
            return !$(".js-forgotten-password-username").attr("data-invalid-user");
        }, loc("forgotten.password.invalid.username"));

        const forgottenPasswordForm = $("#shrForgottenPasswordIdentificationForm");

        if (forgottenPasswordForm.length > 0) {
            forgottenPasswordForm.validate({
                errorElement: 'span',
                errorClass: 'sr-error',
                rules: {
                    username: {
                        required: true,
                        emailOrMobile: true,
                        validUsername: true
                    }
                },
                errorPlacement: function (error, element) {
                    element.parent().append(error);
                },
                onkeyup: function () {
                    ACC.validations.validateForm(forgottenPasswordForm);
                },
                onfocusout: function (element) {
                    this.element(element);
                },
                submitHandler: function (form) {
                    if (ACC.global.runRecaptcha($(form))) {
                        if ($(form).data("useAjax")) {
                            ACC.forgottenpassword.loadPageViaAjax($(form).attr("action"));
                        } else {
                            form.submit();
                        }
                    }
                }
            });
        }
    },

    loadPageViaAjax: function (targetUrl) {
        ACC.global.showLoadingBackgroundMenu();
        $.ajax({
            type: "POST",
            url: targetUrl,
            data: $("#shrForgottenPasswordIdentificationForm").serialize(),
            success: function (data) {
                $(".loading-background").hide();
                if ($(data).hasClass("js-ajax-redirect")) {
                    window.location.href = $(data).data("redirectUrl");
                } else {
                    if ($(data).hasClass("js-forgotten-password-section")) {
                        $(".js-forgotten-password-section").replaceWith(data);
                    } else if ($(data).hasClass("js-header-login-form-section")) {
                        $(".js-header-login-form-section").replaceWith(data);
                        ACC.forgottenpassword.gaEventsTriggers();
                        ACC.forgottenpassword.bindNewPasswordValidation();
                    }

                    ACC.forgottenpassword.loadCommonBindings();
                }
            }
        });
    },

    doInitialValidation: function () {
        const forgottenPasswordForm = $("#shrForgottenPasswordIdentificationForm");
        const username = forgottenPasswordForm.find("#username");
        if (username.val()) {
            ACC.validations.validateForm(forgottenPasswordForm);
            $(".js-forgotten-password-username").removeAttr("data-invalid-user");
        }
    },

    bindForgottenPasswordOtpSubmit: function () {
        $(document).on("click", ".js-forgotten-password-otp .js-otp-submit", function (e) {
            e.preventDefault();
            const forgottenPasswordForm = $("#shrForgottenPasswordIdentificationForm");
            const forgottenPasswordOtpInput = $("#otp");
            const otpInput = $("#oneTimePin");
            forgottenPasswordOtpInput.val(otpInput.val());

            if (forgottenPasswordForm.data("useAjax")) {
                ACC.forgottenpassword.loadPageViaAjax(forgottenPasswordForm.attr("action"));
            } else {
                forgottenPasswordForm.submit();
            }
        });
    },

    bindResendOtpAction: function () {
        $(document).on("click", ".js-resend-otp", function (e) {
            e.preventDefault();
            ACC.forgottenpassword.loadPageViaAjax($(".js-resend-otp").attr("href"));
        });
    },

    bindResendEmailAction: function () {
        $(document).on("click", ".js-resend-email", function (e) {
            e.preventDefault();
            ACC.forgottenpassword.loadPageViaAjax($(this).attr("href"));
        });
    },

    bindBackArrowClick: function () {
        $(document).on("click", ".js-forgotten-password-back-arrow", function (e) {
            e.preventDefault();
            const backUrlAjax = $(".js-forgotten-password-section").data("backUrlAjax");
            if (backUrlAjax) {
                ACC.forgottenpassword.loadPageViaAjax(backUrlAjax);
            } else {
                window.location.href = $(this).attr("href");
            }
        });
    },

    gaEventsTriggers: function () {
        const forgottenPasswordIdentificationButton = $(".forgotten-password-identification-submit");
        if (forgottenPasswordIdentificationButton.length > 0) {
            forgottenPasswordIdentificationButton.on("click", function () {
                const formForgottenPassword = $(this).parents("form");

                const forgottenPasswordData = {
                    "Username": formForgottenPassword.find("[name=username]").val()
                };

                let gaForgottenPasswordAction = "";

                $.each(forgottenPasswordData, function (index, element) {
                    if (element !== "") {
                        gaForgottenPasswordAction += index + " > ";
                    }
                });

                gaForgottenPasswordAction += "Reset";

                ACC.global.gaEvent("Forgot Password", gaForgottenPasswordAction, "Reset");
            });
        }

        const forgottenPasswordSetPasswordButton = $(".forgotten-password-set-password-submit");
        if (forgottenPasswordSetPasswordButton.length > 0) {
            forgottenPasswordSetPasswordButton.on("click", function () {
                ACC.global.gaEvent("Forgot Password", "Set Password", "Reset");
            });
        }

        const fpButtonResendLink = $(".fp-button-resend-link");
        if (fpButtonResendLink.length > 0) {
            fpButtonResendLink.on("click", function () {
                ACC.global.gaEvent("Forgot Password", "Resend Link", "Reset Password");
            });
        }

        const setPasswordSubmit = $(".set-password-submit");
        if (setPasswordSubmit.length > 0) {
            setPasswordSubmit.on("click", function () {
                ACC.global.gaEvent("Forgot Password", "Set new password", "Reset Password");
                sessionStorage.setItem("forgotPassword", "true");
            });
        }

        const newPasswordSuccessfullySet = $(".new-password-successfully-set");
        if (newPasswordSuccessfullySet.length > 0) {
            if (sessionStorage.getItem("forgotPassword") !== "" && sessionStorage.getItem("forgotPassword") !== null) {
                ACC.global.gaEvent("Forgot Password", "Success", "Reset Password");
                sessionStorage.removeItem("forgotPassword");
            }
        }
    },

    bindNewPasswordValidation: function () {
        $.validator.addMethod("passwordGuidelines", function (value, element) {
            return this.optional(element) || ACC.validations.isValidPassword(value);
        }, loc("generic.invalid.password"));

        const setPasswordForm = $("#shrSetPasswordForm");

        if (setPasswordForm.length > 0) {
            setPasswordForm.validate({
                ignore: '.not-active',
                errorElement: 'span',
                errorClass: 'sr-error',
                rules: {
                    pwd: {
                        required: true,
                        passwordGuidelines: true
                    }
                },
                errorPlacement: function (error, element) {
                    element.parent().append(error);
                },
                onkeyup: function () {
                    ACC.validations.validateForm(setPasswordForm);
                },
                onfocusout: function (element) {
                    this.element(element);
                },
                submitHandler: function () {
                    ACC.forgottenpassword.loadConfirmationPageViaAjax(setPasswordForm);
                }
            });
        }
    },

    loadConfirmationPageViaAjax: function ($form) {
        ACC.global.showLoadingBackgroundMenu();
        const url = $form.attr("action");
        const formData = $form.serialize();

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            success: function (response) {
                $(".loading-background").hide();

                const $response = $(response);
                if ($response.hasClass("js-ajax-redirect")) {
                    window.location.href = $response.data("redirectUrl");
                } else {
                    let hasError = false;
                    if ($response.hasClass("js-header-login-form-section")) {
                        $(".js-header-login-form-section").replaceWith($response);
                        hasError = $(".js-header-login-form-section").data('error');
                    } else {
                        $(".js-forgotten-password-form-section__block").replaceWith($response);
                        hasError = $(".js-forgotten-password-form-section__block").data('error');
                    }

                    if (hasError) {
                        ACC.global.loadActionsForm();
                        ACC.global.loadInputEffect();
                        ACC.forgottenpassword.bindNewPasswordValidation();
                    } else {
                        ACC.global.jsCountdown();
                    }
                }
            }
        });
    },

    bindChangeUsername: function () {
        $(document).on('click', '.js-ajax-forgot-password-change-username', function (e) {
            e.preventDefault();
            ACC.global.showLoadingBackgroundMenu();
            $.ajax({
                type: 'GET',
                url: $(this).attr("href"),
                success: function (html) {
                    $(".loading-background").hide();
                    if ($(html).hasClass("js-header-login-form-section")) {
                        $('.loading-background').hide();
                        $(".js-header-login-form-section").replaceWith($(html));

                        ACC.forgottenpassword.loadCommonBindings();
                        ACC.forgottenpassword.gaEventsTriggers();
                    }
                }
            });
        });
    },

    bindAjaxForgotPasswordResendOtpAction: function () {
        $(document).on('click', '.js-ajax-forgot-password-resend-otp', function (e) {
            e.preventDefault();
            ACC.global.showLoadingBackgroundMenu();
            $.ajax({
                type: 'GET',
                url: $(this).attr("href"),
                success: function (html) {
                    $(".loading-background").hide();
                    if ($(html).hasClass("js-header-login-form-section")) {
                        $(".js-header-login-form-section").replaceWith($(html));

                        ACC.otp.reloadOtpBindings();
                        ACC.forgottenpassword.bindChangeUsername();
                    }
                }
            });
        });
    },

    loadCommonBindings: function () {
        ACC.forgottenpassword.bindForgottenPasswordValidation();
        ACC.forgottenpassword.doInitialValidation();
        ACC.global.loadActionsForm();
        ACC.global.loadInputEffect();
        ACC.otp.reloadOtpBindings();
        ACC.otp.bindOtpCountdown();
        ACC.global.loadRecaptchas();
    }
};
