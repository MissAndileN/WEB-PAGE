ACC.faq = {

    _autoload: [
        ["initTypeAhead", $(".typeahead").length > 0],
        ["openAnswerFeedBack", $(".js-show-feedback-popup").length > 0],
        ["openSuggestionFeedback", $(".js-show-suggestion-popup").length > 0]
    ],

    initTypeAhead: function () {
        var body = $('script[data-template="faq-response-body-tmp"]').text();
        var header = $('script[data-template="faq-response-header-tmp"]').text();
        if (typeof faqJson !== "undefined") {
            var data = new Bloodhound({
                name: 'questions',
                local: faqJson.faqs,
                datumTokenizer: function (d) {
                    return Bloodhound.tokenizers.whitespace(d.question);
                },
                queryTokenizer: Bloodhound.tokenizers.whitespace
            });

            data.initialize();

            $('input.typeahead').typeahead({
                    hint: false,
                    highlight: true,
                    minLength: 1,
                    classNames: {
                        input: 'shoprite-input',
                        menu: 'shoprite-menu',
                        dataset: 'shoprite-dataset'
                    }
                },
                {
                    name: 'questions',
                    displayKey: 'question',
                    source: data.ttAdapter(),
                    templates: {
                        header: Handlebars.compile(header),
                        suggestion: Handlebars.compile(body)
                    }
                }
            );
        }
    },

    showPopUp: function (html) {
        ACC.colorbox.open("", {
            className: "show-answer-feedback",
            href: html,
            inline: true,
            width: "620",
            onComplete: function () {
                ACC.faq.feedbackRedirect();
                ACC.faq.sendSuggestion();
                ACC.faq.submitSuggestionEnableButton();
            },
            onClosed: function () {
                $(window).off("resize", colorboxResize);
            }
        });
    },

    openAnswerFeedBack: function () {
        $(".js-show-feedback-popup").click(function () {
            $.ajax({
                url: '/help-centre/answer-feedback',
                type: 'GET',
                success: function (response) {
                    ACC.faq.showPopUp(response);
                },
                error: function () {
                    ACC.faq.showPopUp("Error returning answer feedback data.");
                }
            })
        })
    },

    openSuggestionFeedback: function () {
        $(".js-show-suggestion-popup").click(function () {
            $.ajax({
                url: '/help-centre/suggestion',
                type: 'GET',
                success: function (response) {
                    ACC.faq.showPopUp(response);
                    ACC.faq.faqDidWeAnswerTextArea();
                },
                error: function () {
                    ACC.faq.showPopUp("Error returning answer feedback data.");
                }
            })
        })
    },

    sendSuggestion: function () {
        const $submitSuggestion = $(".js-submit-suggestion");
        if ($submitSuggestion.length > 0) {
            $submitSuggestion.click(function () {
                $.ajax({
                    url: '/help-centre/suggestion',
                    data: {
                        suggestionText: $(".js-suggestion-text-area").val()
                    },
                    type: 'POST',
                    success: function (response) {
                        ACC.faq.showPopUp(response);
                    },
                    error: function () {
                        ACC.faq.showPopUp("Error returning answer feedback data.");
                    }
                });
            });
        }
    },

    submitSuggestionEnableButton: function () {
        const $suggestionTextArea = $(".js-suggestion-text-area");
        if ($suggestionTextArea.length > 0) {
            $suggestionTextArea.keyup(function () {
                let empty = false;
                $suggestionTextArea.each(function () {
                    if ($(this).val().length === 0) {
                        empty = true;
                    }
                });

                const $submitSuggestion = $(".js-submit-suggestion");
                if (empty) {
                    $submitSuggestion.attr("disabled", "disabled");
                } else {
                    $submitSuggestion.attr("disabled", false);
                }
            })
        }
    },

    feedbackRedirect: function () {
        const $buttonRedirectFaq = $(".js-button-redirect-faq");
        if ($buttonRedirectFaq.length > 0) {
            $buttonRedirectFaq.click(function () {
                location.href = '/help-centre';
            });
        }

        const $buttonRedirectFaqHomepage = $(".js-button-redirect-faq-homepage");
        if ($buttonRedirectFaqHomepage.length > 0) {
            $buttonRedirectFaqHomepage.click(function () {
                location.href = '/';
            });
        }
    },

    faqDidWeAnswerTextArea: function () {
        const inputs = $(".js-suggestion-text-area");

        inputs.blur(function () {
            if ($(this).val()) {
                $(this).addClass('used');
            } else {
                $(this).removeClass('used');
            }
        });

        $.each(inputs, function (index, element) {
            const input = $(element);
            if (input.val()) {
                input.addClass("used");
            } else {
                input.removeClass("used")
            }
        })
    }
};
