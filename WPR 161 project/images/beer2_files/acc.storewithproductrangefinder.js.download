ACC.storewithproductrangefinder = {

    _autoload: [
        "saveCurrentLocation",
        "bindSearch",
        "bindPreferredStoreButton",
        "bindDefaultStoreButton",
        "bindChooseAnotherStoreButton"
    ],

    coords: {},

    saveCurrentLocation: function () {
        const storedGeolocation = ACC.global.getStoredGeolocation()
        if(storedGeolocation) {
            ACC.storewithproductrangefinder.coords = storedGeolocation
        } else if(!ACC.global.isGeolocationPermissionDenied()) {
            navigator.geolocation.getCurrentPosition(setCoords, (error) => {
                if(error.code === error.PERMISSION_DENIED) { ACC.global.storeGeolocationPermissionDenied(true) }
            })
        }

        function setCoords(position) {
            ACC.global.setStoredGeolocation(position)
            ACC.storewithproductrangefinder.coords = position.coords
        }
    },

    bindSearch: function () {
        $(document).on("click", ".js-search-stores-with-range-btn", function () {
            const searchForm = $(this).closest(".js-search-stores-with-range-form");
            searchForm.find("input[name='latitude']").val(ACC.storewithproductrangefinder.coords.latitude);
            searchForm.find("input[name='longitude']").val(ACC.storewithproductrangefinder.coords.longitude);
            searchForm.ajaxSubmit({
                success: ACC.storewithproductrangefinder.displayStoresWithProductRangePopup
            });
        });
    },

    bindPreferredStoreButton: function () {
        $(document).on("click", ".js-set-preferred-store-btn-with-popup", function () {
            const setStoreForm = $(this).closest(".js-change-preferred-store-form");
            setStoreForm.ajaxSubmit({
                success: ACC.storewithproductrangefinder.displayConfirmationPopup
            });
        });
    },

    bindDefaultStoreButton: function () {
        $(document).on("click", ".js-change-default-store-btn", function () {
            ACC.storefinder.setPreferredStore($(this).attr("store-name"), $(this).attr("store-display-name"));
        });
    },

    bindChooseAnotherStoreButton: function () {
        $(document).on("click", ".js-choose-another-store-btn", function () {
            ACC.colorbox.close();
        });
    },

    displayStoresWithProductRangePopup: function (responseText) {
        ACC.colorbox.open("", {
            html: responseText,
            maxWidth: "100%",
            width: "380px",
            initialWidth: "380px",
            overlayClose: false,
            escKey: false,
            closeButton: true,
            className: "colorbox-store-finder",
            speed: 350
        });
    },

    displayConfirmationPopup: function (responseText) {
        setTimeout(function () {
            ACC.colorbox.open("", {
                html: responseText,
                maxWidth: "100%",
                width: "380px",
                initialWidth: "380px",
                overlayClose: false,
                escKey: false,
                closeButton: true,
                className: "colorbox-store-finder"
            });
        }, 350);
    }

};
